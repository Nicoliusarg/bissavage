<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BiS por clase/especialización</title>

  <!-- Tooltips Wowhead -->
  <script>const whTooltips = { colorLinks:true, iconizeLinks:true, renameLinks:true };</script>
  <script src="https://wow.zamimg.com/widgets/power.js" defer></script>
  <script src="./bis-feed.js"></script>



  <style>
    :root{ --bg:#0b0e14; --card:#11151c; --muted:#8aa1b1; --text:#e6eef4; --pill:#1a2330; }
    *{ box-sizing:border-box } html,body{ height:100% }
    body{ margin:0; font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Arial; color:var(--text); background:linear-gradient(180deg,#0b0e14,#0b0e14 160px,#0d1117); }
    header{ position:sticky; top:0; z-index:10; background:rgba(11,14,20,.9); backdrop-filter:saturate(140%) blur(8px); border-bottom:1px solid #1e2633; }
    .wrap{ max-width:1100px; margin:0 auto; padding:18px 20px }
    h1{ font-size:22px; margin:0 0 6px; letter-spacing:.2px }
    .muted{ color:var(--muted); font-size:13px }
    .bar{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-top:10px }
    select,button{ appearance:none; background:#0f141c; border:1px solid #273141; color:var(--text); padding:10px 12px; border-radius:10px; font-size:14px; cursor:pointer }
    main{ max-width:1100px; margin:18px auto; padding:0 20px }
    .grid{ display:grid; grid-template-columns:1fr; gap:14px } @media(min-width:740px){ .grid{ grid-template-columns:1fr 1fr } }
    .card{ background:var(--card); border:1px solid #1c2431; border-radius:14px; padding:14px; box-shadow:0 6px 18px rgba(0,0,0,.25) }
    .slot{ font-weight:700; margin-bottom:8px; font-size:14px; color:#b9d3e4 }
    .row{ display:grid; grid-template-columns:56px 1fr; gap:12px; align-items:center }
    .item{ display:flex; flex-direction:column; gap:6px }
    .item a{ text-decoration:none; font-weight:600 }
    .pills{ display:flex; gap:8px; flex-wrap:wrap }
    .pill{ background:var(--pill); border:1px solid #293548; color:#bfe6ff; font-size:12px; padding:6px 8px; border-radius:999px }
    .empty{ color:var(--muted); font-style:italic }
    footer{ color:var(--muted); text-align:center; font-size:12px; padding:26px 0 40px }
    .controls{ display:flex; gap:8px; flex-wrap:wrap }
    .tag{ padding:8px 10px; border-radius:999px; border:1px solid #273141; background:#0f141c; font-size:12px; cursor:pointer; user-select:none }
    .tag.active{ border-color:#3b8ab8; box-shadow:0 0 0 2px rgba(60,140,190,.25) inset }
    .warn{ background:#201c00; border:1px solid #534400; color:#ffec8b; padding:10px 12px; border-radius:10px; font-size:13px; margin-top:6px }
    .error{ background:#2b1111; border:1px solid #5c1d1d; color:#ffb3b3; padding:10px 12px; border-radius:10px; font-size:13px; margin-top:6px; white-space:pre-wrap }
  </style>
</head>
<body>
<header>
  <div class="wrap">
    <h1>BiS por clase/especialización</h1>
    <div class="muted">Lee <code>bis-feed.json</code> si existe; si no, usa el feed incrustado.</div>
    <div class="bar">
      <select id="classSelect" aria-label="Elegí clase"></select>
      <select id="specSelect" aria-label="Elegí especialización"></select>
      <div class="controls" id="filters">
        <span class="tag" data-filter="all">Todo</span>
        <span class="tag" data-filter="raid">Raid</span>
        <span class="tag" data-filter="mplus">Míticas+</span>
        <span class="tag" data-filter="crafted">Crafteo</span>
      </div>
      <button id="refresh">Recargar</button>
      <span class="muted" id="meta"></span>
    </div>
    <div class="warn" id="note">No se encontró <code>bis-feed.json</code>. Usando el feed incrustado.</div>
    <div class="error" id="err" style="display:none"></div>
  </div>
</header>

<main><div class="grid" id="slots"></div></main>
<footer><div>Tooltips por Wowhead • HTML + JSON</div></footer>

<!-- FEED INCRUSTADO: edítalo si querés -->
<script id="bis-feed" type="application/json">
{
  "meta": { "season": "TWW S3", "updated": "inline" },
  "labels": {
    "Warrior": { "label": "Guerrero", "specs": { "Fury": "Furia" } },
    "Hunter":  { "label": "Cazador",  "specs": { "Marksmanship": "Puntería" } }
  },
  "data": {
    "Warrior": {
      "Fury": [
        { "slot": "twoHand",  "id": 34334,  "source": { "type": "raid",    "instance": "Ejemplo", "boss": "Jefe A" } },
        { "slot": "trinket1", "id": 211515, "source": { "type": "mplus",   "dungeon": "Mazmorra X" } },
        { "slot": "ring1",    "id": 178871, "source": { "type": "crafted", "profession": "Joyería" } }
      ]
    },
    "Hunter": {
      "Marksmanship": [
        { "slot": "twoHand", "id": 19019,  "source": { "type": "raid",   "instance": "Ejemplo", "boss": "Jefe B" } },
        { "slot": "trinket2","id": 204202, "source": { "type": "crafted","profession": "Ingeniería" } }
      ]
    }
  }
}
</script>

<script>
const FEED_URL = './bis-feed.json'; // si está online, se usa este. Si falla, usa el inline.
let DATA=null;

function el(tag, attrs={}, children=[]){
  const n=document.createElement(tag);
  for(const [k,v] of Object.entries(attrs)){
    if(k==='class') n.className=v; else if(k==='html') n.innerHTML=v; else n.setAttribute(k,v);
  }
  (Array.isArray(children)?children:[children]).filter(Boolean).forEach(c=>n.appendChild(typeof c==='string'?document.createTextNode(c):c));
  return n;
}

const SLOT_ORDER=['head','neck','shoulder','back','chest','wrist','hands','waist','legs','feet','ring1','ring2','trinket1','trinket2','weaponMain','weaponOff','twoHand'];
const SLOT_LABEL={ head:'Cabeza',neck:'Collar',shoulder:'Hombros',back:'Capa',chest:'Pecho',wrist:'Muñecas',hands:'Manos',waist:'Cintura',legs:'Piernas',feet:'Pies',ring1:'Anillo 1',ring2:'Anillo 2',trinket1:'Abalorio 1',trinket2:'Abalorio 2',weaponMain:'Arma principal',weaponOff:'Arma secundaria',twoHand:'Arma de dos manos' };

let currentClass=null,currentSpec=null,activeFilter='all';

function srcPills(src){
  if(!src) return [];
  if(src.type==='raid')   return [el('span',{class:'pill'},`${src.instance||'Raid'}${src.boss?' — '+src.boss:''}`)];
  if(src.type==='mplus')  return [el('span',{class:'pill'},src.dungeon||'Míticas+')];
  if(src.type==='crafted')return [el('span',{class:'pill'},src.profession?'Crafteo — '+src.profession:'Crafteo')];
  return [el('span',{class:'pill'},'Otro')];
}

function buildSelects(){
  const classSel=document.getElementById('classSelect');
  const specSel=document.getElementById('specSelect');
  classSel.innerHTML=''; specSel.innerHTML='';

  const classes=Object.keys(DATA.data||{}).sort();
  if(!classes.length) throw new Error("DATA.data no tiene clases.");

  classes.forEach(c=>{
    const label=(DATA.labels&&DATA.labels[c]&&DATA.labels[c].label)||c;
    classSel.appendChild(el('option',{value:c},label));
  });

  const savedC=localStorage.getItem('bis_class');
  currentClass=(savedC && DATA.data[savedC])?savedC:classes[0];
  classSel.value=currentClass;

  function fillSpec(){
    specSel.innerHTML='';
    const specKeys=Object.keys(DATA.data[currentClass]||{}).sort();
    specKeys.forEach(s=>{
      const label=(DATA.labels&&DATA.labels[currentClass]&&DATA.labels[currentClass].specs&&DATA.labels[currentClass].specs[s])||s;
      specSel.appendChild(el('option',{value:s},label));
    });
    const savedS=localStorage.getItem('bis_spec');
    currentSpec=(savedS && DATA.data[currentClass][savedS])?savedS:specKeys[0];
    specSel.value=currentSpec;
  }

  classSel.addEventListener('change',()=>{ currentClass=classSel.value; fillSpec(); render(); saveState(); });
  specSel.addEventListener('change', ()=>{ currentSpec=specSel.value; render(); saveState(); });
  fillSpec();
}

function render(){
  const grid=document.getElementById('slots'); grid.innerHTML='';
  const items=(DATA.data[currentClass]&&DATA.data[currentClass][currentSpec])||[];
  const bySlot={}; for(const it of items){ (bySlot[it.slot]=bySlot[it.slot]||[]).push(it); }

  SLOT_ORDER.forEach(slot=>{
    const card=el('div',{class:'card'});
    card.appendChild(el('div',{class:'slot'},SLOT_LABEL[slot]||slot));
    const arr=(bySlot[slot]||[]).filter(it=> activeFilter==='all'?true:(it.source&&it.source.type===activeFilter));
    if(!arr.length){ card.appendChild(el('div',{class:'empty'},'—')); grid.appendChild(card); return; }
    arr.forEach(it=>{
      const row=el('div',{class:'row'});
      const link=el('a',{href:`https://www.wowhead.com/item=${it.id}`,target:'_blank',html:`[item=${it.id}]`});
      row.appendChild(el('div',{html:'&nbsp;'}));
      row.appendChild(el('div',{class:'item'},[link, el('div',{class:'pills'},srcPills(it.source))]));
      card.appendChild(row);
    });
    grid.appendChild(card);
  });

  if(window.$WowheadPower){ $WowheadPower.refreshLinks(); }
  document.getElementById('meta').textContent=`Temporada: ${DATA.meta?.season||''} · Actualizado: ${DATA.meta?.updated||''}`;
}

function bindFilters(){
  const box=document.getElementById('filters');
  const tags=box.querySelectorAll('.tag');
  const set=f=>{ activeFilter=f; tags.forEach(t=>t.classList.toggle('active',t.dataset.filter===f)); render(); };
  tags.forEach(t=>t.addEventListener('click',()=>set(t.dataset.filter)));
  set('all');
}

function saveState(){ localStorage.setItem('bis_class',currentClass); localStorage.setItem('bis_spec',currentSpec); }

async function tryFetchExternal(){
  const url = './bis-feed.json?v=' + Date.now(); // cache-buster
  const res = await fetch(url, { cache:'no-store' });
  if(!res.ok) throw new Error(`HTTP ${res.status} al cargar bis-feed.json`);
  const json = await res.json();
  if(!json || !json.data) throw new Error("El JSON externo no tiene la clave 'data'.");
  return json;
}

function readInline(){
  const raw = document.getElementById('bis-feed')?.textContent?.trim();
  if(!raw) throw new Error('No hay feed incrustado');
  const json = JSON.parse(raw);
  json.meta = json.meta || {};
  json.meta.updated = json.meta.updated || 'inline';
  return json;
}

(async function init(){
  bindFilters();
  document.getElementById('refresh').addEventListener('click',()=>location.reload());
  const errBox=document.getElementById('err');
  try{
    // 1) intento leer el externo
    DATA = await tryFetchExternal();
    document.getElementById('note').style.display='none';
  }catch(e1){
    try{
      // 2) si falla, uso el incrustado
      DATA = readInline();
      document.getElementById('note').style.display='block';
    }catch(e2){
      errBox.style.display='block';
      errBox.textContent = 'No pude cargar el feed externo ni el incrustado.\n' +
                           'Error externo: ' + e1.message + '\n' +
                           'Error inline: ' + e2.message;
      return;
    }
  }
  buildSelects();
  render();
})();
</script>
</body>
</html>

