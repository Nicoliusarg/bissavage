<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BiS por clase/especialización</title>

  <!-- Wowhead tooltips -->
  <script>const whTooltips={colorLinks:true,iconizeLinks:true,renameLinks:true};</script>
  <script src="https://wow.zamimg.com/widgets/power.js"></script>

  <!-- FEEDS (en este orden): primero BiS, luego íconos de Blizzard -->
  <script src="./bis-feed.js"></script>
  <script src="./wow-icons.js"></script>

  <style>
    :root{ --bg:#0b0e14; --card:#11151c; --muted:#8aa1b1; --text:#e6eef4; --pill:#1a2330; }
    *{ box-sizing:border-box } html,body{ height:100% }
    body{ margin:0; font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Arial; color:var(--text); background:linear-gradient(180deg,#0b0e14,#0b0e14 160px,#0d1117); }
    header{ position:sticky; top:0; z-index:10; background:rgba(11,14,20,.9); backdrop-filter:saturate(140%) blur(8px); border-bottom:1px solid #1e2633; }
    .wrap{ max-width:1100px; margin:0 auto; padding:18px 20px }
    h1{ font-size:22px; margin:0 0 6px; letter-spacing:.2px }
    .muted{ color:var(--muted); font-size:13px }
    .bar{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-top:10px }
    select,button{ appearance:none; background:#0f141c; border:1px solid #273141; color:var(--text); padding:10px 12px; border-radius:10px; font-size:14px; cursor:pointer }
    main{ max-width:1100px; margin:18px auto; padding:0 20px }
    .grid{ display:grid; grid-template-columns:1fr; gap:14px } @media(min-width:740px){ .grid{ grid-template-columns:1fr 1fr } }
    .card{ background:var(--card); border:1px solid #1c2431; border-radius:14px; padding:14px; box-shadow:0 6px 18px rgba(0,0,0,.25) }
    .slot{ font-weight:700; margin-bottom:8px; font-size:14px; color:#b9d3e4 }
    .row{ display:grid; grid-template-columns:56px 1fr; gap:12px; align-items:center }
    .item{ display:flex; flex-direction:column; gap:6px }
    .item a{ text-decoration:none; font-weight:600 }
    .pills{ display:flex; gap:8px; flex-wrap:wrap }
    .pill{ background:var(--pill); border:1px solid #293548; color:#bfe6ff; font-size:12px; padding:6px 8px; border-radius:999px }
    .empty{ color:var(--muted); font-style:italic }
    footer{ color:var(--muted); text-align:center; font-size:12px; padding:26px 0 40px }
    .controls{ display:flex; gap:8px; flex-wrap:wrap }
    .tag{ padding:8px 10px; border-radius:999px; border:1px solid #273141; background:#0f141c; font-size:12px; cursor:pointer; user-select:none }
    .tag.active{ border-color:#3b8ab8; box-shadow:0 0 0 2px rgba(60,140,190,.25) inset }
    .error{ display:none; background:#2b1111; border:1px solid #5c1d1d; color:#ffb3b3; padding:10px 12px; border-radius:10px; font-size:13px; margin-top:6px; white-space:pre-wrap }

    /* --- barra de íconos de clases --- */
    .iconsbar{ display:flex; gap:8px; flex-wrap:wrap; margin:10px 0 }
    .icbtn{ display:flex; align-items:center; gap:8px; background:#0f141c; border:1px solid #273141; color:#e6eef4; padding:6px 10px; border-radius:999px; cursor:pointer }
    .icbtn img{ width:18px; height:18px; border-radius:50% }
    .icbtn.active{ outline:2px solid rgba(124,211,255,.25) }
  </style>
</head>
<body>
<header>
  <div class="wrap">
    <h1>BiS por clase/especialización</h1>
    <div class="muted">Datos desde <code>bis-feed.js</code> · <span id="meta"></span></div>

    <!-- Barra de íconos de CLASES -->
    <div id="classIcons" class="iconsbar"></div>

    <div class="bar">
      <select id="classSelect" aria-label="Elegí clase"></select>
      <select id="specSelect" aria-label="Elegí especialización"></select>
      <div class="controls" id="filters">
        <span class="tag" data-filter="all">Todo</span>
        <span class="tag" data-filter="raid">Raid</span>
        <span class="tag" data-filter="mplus">Míticas+</span>
        <span class="tag" data-filter="crafted">Crafteo</span>
      </div>
      <button id="refresh">Recargar</button>
    </div>
    <div class="error" id="err"></div>
  </div>
</header>

<main><div class="grid" id="slots"></div></main>
<footer><div>Tooltips por Wowhead • HTML + JS</div></footer>

<script>
/* === Datos (cargados por bis-feed.js) === */
let DATA = window.BIS_FEED || null;

/* === Utilidades/UI === */
function el(tag, attrs={}, children=[]){
  const n=document.createElement(tag);
  for(const [k,v] of Object.entries(attrs)){
    if(k==='class') n.className=v;
    else if(k==='html') n.innerHTML=v;
    else n.setAttribute(k,v);
  }
  (Array.isArray(children)?children:[children]).filter(Boolean).forEach(c=>n.appendChild(typeof c==='string'?document.createTextNode(c):c));
  return n;
}
const SLOT_ORDER=['head','neck','shoulder','back','chest','wrist','hands','waist','legs','feet','ring1','ring2','trinket1','trinket2','weaponMain','weaponOff','twoHand'];
const SLOT_LABEL={ head:'Cabeza',neck:'Collar',shoulder:'Hombros',back:'Capa',chest:'Pecho',wrist:'Muñecas',hands:'Manos',waist:'Cintura',legs:'Piernas',feet:'Pies',ring1:'Anillo 1',ring2:'Anillo 2',trinket1:'Abalorio 1',trinket2:'Abalorio 2',weaponMain:'Arma principal',weaponOff:'Arma secundaria',twoHand:'Arma de dos manos' };
let currentClass=null,currentSpec=null,activeFilter='all';

/* Mapeo clase → ID oficial de Blizzard (para WOW_ICONS) */
const CLASS_ID_BY_KEY={
  "Warrior":1,"Paladin":2,"Hunter":3,"Rogue":4,"Priest":5,
  "Death Knight":6,"Shaman":7,"Mage":8,"Warlock":9,"Monk":10,
  "Druid":11,"Demon Hunter":12,"Evoker":13
};

function srcPills(src){
  if(!src) return [];
  if(src.type==='raid')   return [el('span',{class:'pill'},`${src.instance||'Raid'}${src.boss?' — '+src.boss:''}`)];
  if(src.type==='mplus')  return [el('span',{class:'pill'},src.dungeon||'Míticas+')];
  if(src.type==='crafted')return [el('span',{class:'pill'},src.profession?'Crafteo — '+src.profession:'Crafteo')];
  return [el('span',{class:'pill'},'Otro')];
}

function buildSelects(){
  const classSel=document.getElementById('classSelect');
  const specSel=document.getElementById('specSelect');
  classSel.innerHTML=''; specSel.innerHTML='';

  const classes=Object.keys(DATA.data||{}).sort();
  classes.forEach(c=>{
    const label=(DATA.labels?.[c]?.label)||c;
    classSel.appendChild(el('option',{value:c},label));
  });

  const savedC=localStorage.getItem('bis_class');
  currentClass=(savedC && DATA.data[savedC])?savedC:classes[0];
  classSel.value=currentClass;

  function fillSpec(){
    specSel.innerHTML='';
    const specKeys=Object.keys(DATA.data[currentClass]||{}).sort();
    specKeys.forEach(s=>{
      const label=(DATA.labels?.[currentClass]?.specs?.[s])||s;
      specSel.appendChild(el('option',{value:s},label));
    });
    const savedS=localStorage.getItem('bis_spec');
    currentSpec=(savedS && DATA.data[currentClass]?.[savedS])?savedS:specKeys[0];
    specSel.value=currentSpec;
  }

  classSel.addEventListener('change',()=>{ currentClass=classSel.value; fillSpec(); render(); saveState(); renderClassIcons(); });
  specSel.addEventListener('change', ()=>{ currentSpec=specSel.value; render(); saveState(); });

  fillSpec();
}

/* --- barra de íconos de clase (usa window.WOW_ICONS generada desde Blizzard) --- */
function renderClassIcons(){
  const box=document.getElementById('classIcons');
  if(!box) return;
  const iconData = window.WOW_ICONS?.classes || {};
  box.innerHTML='';

  const classes=Object.keys(DATA.data||{}).sort();
  classes.forEach(k=>{
    const id = CLASS_ID_BY_KEY[k];
    const ic = iconData[id]?.icon || '';       // URL oficial
    const label = (DATA.labels?.[k]?.label) || k;

    const btn=document.createElement('button');
    btn.className='icbtn' + (k===currentClass ? ' active':'');
    btn.innerHTML = (ic? `<img src="${ic}" alt="">` : '') + label;

    btn.onclick=()=>{
      if(k===currentClass) return;
      currentClass=k;
      // actualizar selects
      const cSel=document.getElementById('classSelect');
      const sSel=document.getElementById('specSelect');
      cSel.value=k;
      sSel.innerHTML='';
      Object.keys(DATA.data[k]).sort().forEach(s=>{
        const lbl=(DATA.labels?.[k]?.specs?.[s])||s;
        sSel.appendChild(new Option(lbl, s));
      });
      currentSpec=sSel.value;
      saveState();
      render();
      renderClassIcons(); // refresca active
    };

    box.appendChild(btn);
  });
}

function render(){
  const grid=document.getElementById('slots'); grid.innerHTML='';
  const items=(DATA.data[currentClass]?.[currentSpec])||[];
  const bySlot={}; for(const it of items){ (bySlot[it.slot]=bySlot[it.slot]||[]).push(it); }

  SLOT_ORDER.forEach(slot=>{
    const card=el('div',{class:'card'});
    card.appendChild(el('div',{class:'slot'},SLOT_LABEL[slot]||slot));
    const arr=(bySlot[slot]||[]).filter(it=> activeFilter==='all'?true:(it.source?.type===activeFilter));
    if(!arr.length){ card.appendChild(el('div',{class:'empty'},'—')); grid.appendChild(card); return; }
    arr.forEach(it=>{
      const row=el('div',{class:'row'});
      const link=el('a',{href:`https://www.wowhead.com/item=${it.id}`,target:'_blank',html:`[item=${it.id}]`});
      row.appendChild(el('div',{html:'&nbsp;'}));
      row.appendChild(el('div',{class:'item'},[link, el('div',{class:'pills'},srcPills(it.source))]));
      card.appendChild(row);
    });
    grid.appendChild(card);
  });

  if(window.$WowheadPower){ $WowheadPower.refreshLinks(); }
  document.getElementById('meta').textContent=`Temporada: ${DATA.meta?.season||''} · Actualizado: ${DATA.meta?.updated||''}`;
}

function bindFilters(){
  const box=document.getElementById('filters');
  const tags=box.querySelectorAll('.tag');
  const set=f=>{ activeFilter=f; tags.forEach(t=>t.classList.toggle('active',t.dataset.filter===f)); render(); };
  tags.forEach(t=>t.addEventListener('click',()=>set(t.dataset.filter)));
  set('all');
}
function saveState(){ localStorage.setItem('bis_class',currentClass); localStorage.setItem('bis_spec',currentSpec); }

/* === Inicialización === */
(function init(){
  document.getElementById('refresh').addEventListener('click', ()=>location.reload());
  bindFilters();

  if(!DATA || !DATA.data){
    const err=document.getElementById('err');
    err.style.display='block';
    err.textContent='window.BIS_FEED no está definido. Verificá que bis-feed.js exista y se cargue sin errores.';
    return;
  }

  buildSelects();
  renderClassIcons();   // <- NUEVO
  render();
})();
</script>
</body>
</html>
